-- üíæ Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local ProximityPromptService = game:GetService("ProximityPromptService")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- Global Feature Toggles
_G.FeatureToggles = {
	RakeESP = true,
	ScrapESP = true,
	AutoCollect = true,
	FlareGunESP = true,
	LightingLock = true
}

-- UI Setup
local gui = Instance.new("ScreenGui")
gui.Name = "FeatureToggleUI"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local function makeToggle(name, order, toggleKey)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(0, 200, 0, 40)
	btn.Position = UDim2.new(0, 10, 0, 50 + (order * 45))
	btn.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
	btn.TextColor3 = Color3.fromRGB(255, 255, 255)
	btn.Font = Enum.Font.SourceSansBold
	btn.TextSize = 20
	btn.Text = name .. ": ON"
	btn.Parent = gui

	btn.MouseButton1Click:Connect(function()
		_G.FeatureToggles[toggleKey] = not _G.FeatureToggles[toggleKey]
		btn.Text = name .. ": " .. (_G.FeatureToggles[toggleKey] and "ON" or "OFF")
	end)
end

makeToggle("Rake ESP", 0, "RakeESP")
makeToggle("Scrap ESP", 1, "ScrapESP")
makeToggle("Auto Collect", 2, "AutoCollect")
makeToggle("FlareGun ESP", 3, "FlareGunESP")
makeToggle("Lighting Lock", 4, "LightingLock")

-- üßç Character Setup
local character = player.Character or player.CharacterAdded:Wait()
local HRP = character:WaitForChild("HumanoidRootPart")

-- üî¥ Rake ESP
local function createESP(target, name, fillColor)
	if not target:FindFirstChild(name .. "ESP") then
		local highlight = Instance.new("Highlight")
		highlight.Name = name .. "ESP"
		highlight.FillColor = fillColor
		highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
		highlight.FillTransparency = 0.5
		highlight.OutlineTransparency = 0
		highlight.Adornee = target
		highlight.Parent = target
	end
end

local function applyRakeESP()
	if not _G.FeatureToggles.RakeESP then return end
	local rake = workspace:FindFirstChild("Rake", true)
	if rake then
		createESP(rake, "Rake", Color3.fromRGB(255, 0, 0))
	end
end

workspace.ChildAdded:Connect(function(child)
	if _G.FeatureToggles.RakeESP and child.Name == "Rake" then
		task.wait(0.1)
		applyRakeESP()
	end
end)

applyRakeESP()

-- üü° Scrap ESP + Auto Collect
local collectDistance = 10

local function handleScrap(scrap)
	if not _G.FeatureToggles.ScrapESP then return end
	if scrap:IsA("PVInstance") and not scrap:FindFirstChild("ScrapESP") then
		local highlight = Instance.new("Highlight")
		highlight.Name = "ScrapESP"
		highlight.FillColor = Color3.fromRGB(255, 255, 0)
		highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
		highlight.FillTransparency = 0.3
		highlight.OutlineTransparency = 0
		highlight.Adornee = scrap
		highlight.Parent = scrap
	end
end

for _, obj in ipairs(workspace:GetDescendants()) do
	if obj.Name == "Scrap" then
		handleScrap(obj)
	end
end

workspace.DescendantAdded:Connect(function(descendant)
	if descendant.Name == "Scrap" then
		task.wait(0.1)
		handleScrap(descendant)
	end
end)

ProximityPromptService.PromptShown:Connect(function(prompt, inputType)
	if not _G.FeatureToggles.AutoCollect then return end
	local parent = prompt.Parent
	if parent and parent.Name == "Scrap" then
		local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
		if hrp and (hrp.Position - parent.Position).Magnitude <= collectDistance then
			task.wait(0.05)
			pcall(function()
				prompt:InputHoldBegin()
				task.wait(0.1)
				prompt:InputHoldEnd()
			end)
		end
	end
end)

-- üü¢ FlareGun ESP + Notification
local flareGunESP = {}
local function notify(msg)
	pcall(function()
		game.StarterGui:SetCore("SendNotification", {
			Title = "FlareGun Update",
			Text = msg,
			Duration = 3
		})
	end)
end

local function applyFlareGunESP(flareGun)
	if not _G.FeatureToggles.FlareGunESP then return end
	if flareGun:FindFirstChild("FlareGunESP") then return end
	local primaryPart = flareGun:IsA("Model") and (flareGun.PrimaryPart or flareGun:FindFirstChildWhichIsA("BasePart")) or flareGun
	if primaryPart then
		local highlight = Instance.new("Highlight")
		highlight.Name = "FlareGunESP"
		highlight.FillColor = Color3.fromRGB(0, 255, 0)
		highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
		highlight.FillTransparency = 0.3
		highlight.OutlineTransparency = 0
		highlight.Adornee = flareGun
		highlight.Parent = flareGun
	end
end

local function watchFlareGun(flareGun)
	if flareGunESP[flareGun] or not _G.FeatureToggles.FlareGunESP then return end
	if flareGun.Parent and flareGun.Parent.Name == "Collectibles" then
		flareGunESP[flareGun] = true
		applyFlareGunESP(flareGun)
		notify("‚úÖ FlareGun is available in Collectibles!")
		flareGun.AncestryChanged:Connect(function(_, newParent)
			if not flareGun:IsDescendantOf(workspace) or (newParent and newParent.Name ~= "Collectibles") then
				if flareGunESP[flareGun] then
					notify("‚ùå FlareGun was collected or removed!")
					flareGunESP[flareGun] = nil
				end
			end
		end)
	end
end

workspace.DescendantAdded:Connect(function(descendant)
	if descendant.Name == "FlareGun" then
		task.wait(0.1)
		watchFlareGun(descendant)
	end
end)

for _, obj in ipairs(workspace:GetDescendants()) do
	if obj.Name == "FlareGun" then
		watchFlareGun(obj)
	end
end

-- üîÜ Lighting Lock
local desiredBrightness = 2
local desiredDiffuse = 1
local desiredAtmosphereColor = Color3.fromRGB(107, 107, 107)
local desiredAtmosphereDensity = 0.4

local function getAtmosphere()
	local atmosphere = Lighting:FindFirstChildOfClass("Atmosphere")
	if not atmosphere then
		atmosphere = Instance.new("Atmosphere")
		atmosphere.Parent = Lighting
	end
	return atmosphere
end

local function lockLightingSettings()
	if not _G.FeatureToggles.LightingLock then return end
	Lighting.Brightness = desiredBrightness
	Lighting.EnvironmentDiffuseScale = desiredDiffuse

	Lighting:GetPropertyChangedSignal("Brightness"):Connect(function()
		if _G.FeatureToggles.LightingLock and Lighting.Brightness ~= desiredBrightness then
			Lighting.Brightness = desiredBrightness
		end
	end)

	Lighting:GetPropertyChangedSignal("EnvironmentDiffuseScale"):Connect(function()
		if _G.FeatureToggles.LightingLock and Lighting.EnvironmentDiffuseScale ~= desiredDiffuse then
			Lighting.EnvironmentDiffuseScale = desiredDiffuse
		end
	end)
end

local function lockAtmosphereSettings()
	if not _G.FeatureToggles.LightingLock then return end
	local atmosphere = getAtmosphere()
	atmosphere.Color = desiredAtmosphereColor
	atmosphere.Density = desiredAtmosphereDensity

	atmosphere:GetPropertyChangedSignal("Color"):Connect(function()
		if _G.FeatureToggles.LightingLock and atmosphere.Color ~= desiredAtmosphereColor then
			atmosphere.Color = desiredAtmosphereColor
		end
	end)

	atmosphere:GetPropertyChangedSignal("Density"):Connect(function()
		if _G.FeatureToggles.LightingLock and atmosphere.Density ~= desiredAtmosphereDensity then
			atmosphere.Density = desiredAtmosphereDensity
		end
	end)
end

lockLightingSettings()
lockAtmosphereSettings()
